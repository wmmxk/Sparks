{"version":"NotebookV1","origId":503877321546867,"name":"06-DE-GF-ETL","language":"scala","commands":[{"version":"CommandV1","origId":503877321546869,"guid":"cd825c33-6a53-45ac-92c5-6a989b731800","subtype":"command","commandType":"auto","position":1.0,"command":"%md ### Warning: Do not run this notebook! It is for reference only!\n\n(Since you don't have write permissions to `/mnt/wikipedia-readonly`, you'll get an error)","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"758e3cec-777e-4345-aee3-a7301df9f15f"},{"version":"CommandV1","origId":503877321546870,"guid":"4b6ce804-8693-4a36-81a8-52a831eb6561","subtype":"command","commandType":"auto","position":2.0,"command":"import org.apache.spark.sql._\nimport org.apache.spark.sql.functions._","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"402f15bf-31fa-4ca4-bd2f-b50f93d1a4e2"},{"version":"CommandV1","origId":503877321546871,"guid":"56095ea9-1c31-4175-b595-702de4109fae","subtype":"command","commandType":"auto","position":3.0,"command":"%md #### Create the vertices DF:","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"52de6320-3fca-4c50-91ab-2023fc657a48"},{"version":"CommandV1","origId":503877321546872,"guid":"e1f1f73e-8cd0-4169-b2c6-76be2c45ffeb","subtype":"command","commandType":"auto","position":4.0,"command":"val othersDF = sqlContext.createDataFrame(List(\n  (1, \"other-wikipedia\"),\n  (2, \"other-empty\"),\n  (3, \"other-internal\"),\n  (4, \"other-google\"),\n  (5, \"other-yahoo\"),\n  (6, \"other-bing\"),\n  (7, \"other-facebook\"),\n  (8, \"other-twitter\"),\n  (9, \"other-other\")\n)).toDF(\"id\", \"id_title\")","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"b11cef81-f8d4-49f1-ab6d-527c70fb9a65"},{"version":"CommandV1","origId":503877321546873,"guid":"2b50ae2a-8884-4d07-92cf-8ee092e87fe6","subtype":"command","commandType":"auto","position":5.0,"command":"%md Write the verticesDF to S3 to read in next lab:","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"f87be523-f5fd-4994-831d-f6da386dca0b"},{"version":"CommandV1","origId":503877321546874,"guid":"66daaece-6f54-4afb-be17-59bd6d00c503","subtype":"command","commandType":"auto","position":6.0,"command":"//takes 130 sec to run\n\nval verticesDF = sqlContext.read.format(\"com.databricks.spark.csv\")\n  .option(\"header\", \"true\")\n  .option(\"delimiter\", \"\\\\t\")\n  .option(\"mode\", \"PERMISSIVE\")\n  .option(\"inferSchema\", \"true\")\n  .load(\"dbfs:///databricks-datasets/wikipedia-datasets/data-001/clickstream/raw-uncompressed\")\n  .select($\"curr_id\".alias(\"id\"), $\"curr_title\".alias(\"id_title\"))\n  .distinct\n  .filter($\"id\".isNotNull)\n  .unionAll(othersDF)\n  .repartition(60) // If 100, Each of the partitions will be ~824.0 KB in memory\n  .write.parquet(\"/mnt/wikipedia-readonly/gx_clickstream/vertices\") ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"44f57b06-63ff-4af3-a1d4-b19a9503c5ee"},{"version":"CommandV1","origId":503877321546875,"guid":"739e50a2-490d-416a-964b-1859307262fb","subtype":"command","commandType":"auto","position":7.0,"command":"%md #### Create the edges DF:","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"0b56507f-6371-4937-9d67-71932422518b"},{"version":"CommandV1","origId":503877321546876,"guid":"7b8fda4c-0b82-4b7b-b489-b239bc65671b","subtype":"command","commandType":"auto","position":8.0,"command":"%md Write the edgesDF to S3 to read in next lab:","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"bff1316b-f3ca-4e5a-a984-7e1d976a1b40"},{"version":"CommandV1","origId":503877321546877,"guid":"7699bec6-d138-4de9-af8d-caf107a7ed2f","subtype":"command","commandType":"auto","position":9.0,"command":"//takes 180 sec to run\n\nval edgesDF = sqlContext.read.format(\"com.databricks.spark.csv\")\n  .option(\"header\", \"true\")\n  .option(\"delimiter\", \"\\\\t\")\n  .option(\"mode\", \"PERMISSIVE\")\n  .option(\"inferSchema\", \"true\")\n  .load(\"dbfs:///databricks-datasets/wikipedia-datasets/data-001/clickstream/raw-uncompressed\")\n  .select($\"prev_id\".alias(\"src\"), $\"curr_id\".alias(\"dst\"), $\"type\", $\"n\", $\"prev_title\".alias(\"src_title\"), $\"curr_title\".alias(\"dst_title\"))\n  .select($\"src\", when($\"src_title\" === \"other-wikipedia\", 1)\n  .when($\"src_title\" === \"other-empty\", 2)\n  .when($\"src_title\" === \"other-internal\", 3)\n  .when($\"src_title\" === \"other-google\", 4)\n  .when($\"src_title\" === \"other-yahoo\", 5)\n  .when($\"src_title\" === \"other-bing\", 6)\n  .when($\"src_title\" === \"other-facebook\", 7)\n  .when($\"src_title\" === \"other-twitter\", 8)\n  .when($\"src_title\" === \"other-other\", 9)\n  .otherwise($\"src\").alias(\"new_src\"), $\"dst\", $\"type\", $\"n\", $\"src_title\", $\"dst_title\")\n  .drop($\"src\")\n  .withColumnRenamed(\"new_src\", \"src\")\n  .filter($\"type\" !== \"redlink\")\n  .repartition(60) // If 100, Each of the partitions will be ~11 MB in memory\n  .write.parquet(\"/mnt/wikipedia-readonly/gx_clickstream/edges\") ","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"03501715-eb67-467c-824d-cb9bf398142a"},{"version":"CommandV1","origId":503877321546878,"guid":"46d41dde-8fd6-458f-9a09-1045cef55186","subtype":"command","commandType":"auto","position":10.0,"command":"","commandVersion":0,"state":"finished","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0.0,"submitTime":0.0,"finishTime":0.0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"nuid":"2baabf08-9d2b-4579-9f85-34aa6ab69408"}],"dashboards":[],"guid":"15562152-ca63-4ec1-a7a7-ce95db52e3b0","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}